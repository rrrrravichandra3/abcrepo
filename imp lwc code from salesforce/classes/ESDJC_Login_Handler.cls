global class ESDJC_Login_Handler implements Auth.RegistrationHandler{    private Integer MIN_USER_ID_LENGTH = 2;    private ESDJC_Settings__c settings = ESDJC_Settings__c.getInstance();        global User createUser(Id portalId, Auth.UserData data){                System.debug('++++createUser portalId='+portalId+', data='+data);        User u = getExistingDJCUser(getDJCUserName(data.username));        //User uu = u.clone(false, true);        //insert uu;        return u;    }     global void updateUser(Id userId, Id portalId, Auth.UserData data){               System.debug('++++updateUser portalId='+portalId+', data='+data);           }         private User getExistingDJCUser(String djcUsername) {        System.debug('+++getExistingDJCUser djcUsername='+djcUsername);        if(!djcUsername.contains('null@dreamjobcentral.com')){        List<User> pfUsers = [SELECT Username, ContactId, Email, FirstName, LastName, Alias, CommunityNickname, languagelocalekey,localesidkey, timeZoneSidKey, emailEncodingKey, Manager__c, Department , UserRoleId , CurrencyIsoCode , IsActive FROM User WHERE userName =:djcUsername AND IsActive = true];        System.debug('+++getExistingDJCUser pfUsers='+pfUsers);        if(pfUsers.size() > 0){            return pfUsers.get(0);           }        }                if(settings.ESDJC_Allow_Guest_portal_user__c){         	return getDreamJobCentralSiteGuestUser();         }               return null;    }	private User getDreamJobCentralSiteGuestUser() {            ESDJC_Settings__c settings = ESDJC_Settings__c.getInstance();        if(settings.Portal_Guest_Username__c != null && settings.Portal_Guest_Username__c.length() > 0){	        System.debug('+++getDreamJobCentralSiteGuestUser');	        List<User> pfUsers = [SELECT Username, ContactId, Email, FirstName, LastName, Alias, CommunityNickname, languagelocalekey,localesidkey, timeZoneSidKey, emailEncodingKey, Manager__c, Department , UserRoleId , CurrencyIsoCode , IsActive FROM User WHERE Username = :settings.Portal_Guest_Username__c AND IsActive = true];	        //List<User> pfUsers = [SELECT Username, ContactId, Email, FirstName, LastName, Alias, CommunityNickname, languagelocalekey,localesidkey, timeZoneSidKey, emailEncodingKey, Manager__c, Department , UserRoleId , CurrencyIsoCode , IsActive FROM User WHERE id = '00570000002Sp1r' AND IsActive = true];	        System.debug('+++getDreamJobCentralSiteGuestUser ='+pfUsers);	        if(pfUsers.size() > 0){	            return pfUsers.get(0);	        }            }           return null;       	}        private String getDJCUserName(String loginId) {        ESDJC_Settings__c settings = ESDJC_Settings__c.getInstance();        String  DJC_ORG    = '@'+settings.SSO_Dreamjobcentral_ID__c;        System.debug('+++getDJCUserName loginId='+loginId);        return getUserName(loginId)+DJC_ORG;    }    private String getUserName(String loginId) {        ESDJC_Settings__c settings = ESDJC_Settings__c.getInstance();        String EXT_ORG   = '@'+settings.SSO_Identity_Org__c ;        System.debug('+++getUserName loginId='+loginId);        if(loginId != null) {            loginId = loginId.trim();            if(loginId.length() >= MIN_USER_ID_LENGTH){                Integer index = -1;                if(loginId.endsWith(EXT_ORG)){                    index = loginId.indexOfIgnoreCase(EXT_ORG);                    if(index >= MIN_USER_ID_LENGTH){                        return loginId.substring(0, index);                    }                }            }        }        return null;    }       }